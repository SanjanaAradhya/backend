<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTU Exam Registration Chatbot with Voice Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced CSS for Voice-Enabled VTU Chatbot */
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --chat-bg: #ffffff;
            --bot-msg-bg: #f1f5f9;
            --user-msg-bg: #3b82f6;
            --border-color: #e2e8f0;
            --voice-active: #ef4444;
            --voice-inactive: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            background: var(--chat-bg);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chat-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .reset-chat {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .reset-chat:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--light-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: fadeInUp 0.3s ease;
            position: relative;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background: var(--bot-msg-bg);
            color: var(--dark-color);
            align-self: flex-start;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: var(--user-msg-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .success-message {
            background: var(--success-color);
            color: white;
        }

        .error-message {
            background: var(--danger-color);
            color: white;
        }

        .message-content {
            line-height: 1.5;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 8px;
            text-align: right;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .voice-control-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--secondary-color);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-control-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .voice-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .voice-button.listening {
            background: linear-gradient(135deg, var(--voice-active), #dc2626);
            animation: voicePulse 1s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .voice-button:not(.listening) {
            background: linear-gradient(135deg, var(--voice-inactive), #4b5563);
        }

        .voice-button:hover {
            transform: scale(1.05);
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: var(--bot-msg-bg);
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            max-width: 80%;
            align-self: flex-start;
            border: 1px solid var(--border-color);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 200ms; }
        .typing-dot:nth-child(3) { animation-delay: 400ms; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .voice-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .voice-status.listening {
            display: flex;
            background: var(--voice-active);
        }

        .voice-status.processing {
            display: flex;
            background: var(--warning-color);
        }

        .voice-wave {
            width: 4px;
            height: 20px;
            background: white;
            margin: 0 1px;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }

        .voice-wave:nth-child(2) { animation-delay: 0.1s; }
        .voice-wave:nth-child(3) { animation-delay: 0.2s; }
        .voice-wave:nth-child(4) { animation-delay: 0.3s; }

        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 1px solid var(--secondary-color);
            background: white;
            color: var(--secondary-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-radius: 20px;
            margin: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .welcome-message i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .welcome-message h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .voice-instructions {
            background: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--secondary-color);
        }

        .voice-instructions h5 {
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .voice-instructions ul {
            margin: 0;
            padding-left: 20px;
        }

        .voice-instructions li {
            color: #6b7280;
            margin-bottom: 5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-width: none;
                margin: 0;
                border-radius: 0;
            }

            .message {
                max-width: 90%;
            }

            .chat-header h1 {
                font-size: 1.4rem;
            }

            .reset-chat {
                position: static;
                margin-top: 10px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }

            .voice-status {
                top: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Navigation Links */
        .nav-links {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            margin-right: 15px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            color: white;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Voice Status Indicator -->
    <div class="voice-status" id="voiceStatus">
        <i class="fas fa-microphone"></i>
        <span id="voiceStatusText">Listening...</span>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
    </div>

    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <!-- Navigation Links -->
            <div class="nav-links">
                <a href="/dashboard">üìä Dashboard</a>
                <a href="/subjects">üìö Subjects</a>
                <a href="/admin">üë• Admin</a>
                <a class="nav-link" href="/exam-scheduler">ü§ñ AI Scheduler</a>
                <a href="/allocation_results">üéüÔ∏è Allocation Results</a>

            </div>

            <h1><i class="fas fa-graduation-cap me-2"></i>VTU Exam Registration</h1>
            <p>Intelligent Voice-Enabled Assistant for VTU Exam Registration</p>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
            <button class="reset-chat" onclick="resetChat()">
                <i class="fas fa-refresh me-1"></i>Reset Chat
            </button>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <i class="fas fa-robot"></i>
                <h3>Welcome to VTU Voice-Enabled Registration Bot!</h3>
                <p>I can help you register for VTU exams using both text and voice input. Students are organized by their selected subjects for proper management!</p>

                <div class="voice-instructions">
                    <h5><i class="fas fa-microphone me-2"></i>Voice Features:</h5>
                    <ul style="text-align: left; margin-top: 10px;">
                        <li>üé§ Click the microphone button to speak</li>
                        <li>üó£Ô∏è Speak your responses naturally</li>
                        <li>‚å®Ô∏è You can also type as usual</li>
                        <li>üîÑ Switch between voice and text anytime</li>
                        <li>üìö Your details will be stored under each subject you select</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <i class="fas fa-robot" style="color: var(--secondary-color);"></i>
            <span>Bot is typing</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <div class="input-group">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type your message or click mic to speak..." 
                    maxlength="500"
                    autocomplete="off"
                >
                <div class="voice-controls">
                    <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecording()">
                        <i class="fas fa-microphone" id="voiceIcon"></i>
                    </button>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="action-btn" onclick="sendQuickMessage('Hi')">
                    <i class="fas fa-play me-1"></i>Get Started
                </button>
                <button class="action-btn" onclick="sendQuickMessage('Help')">
                    <i class="fas fa-question me-1"></i>Help
                </button>
                <button class="action-btn" onclick="resetChat()">
                    <i class="fas fa-refresh me-1"></i>Reset
                </button>
                <button class="action-btn" onclick="testVoice()">
                    <i class="fas fa-microphone-alt me-1"></i>Test Voice
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables for voice-enabled VTU chatbot
        let isTyping = false;
        let chatHistory = [];
        let isListening = false;
        let recognition = null;
        let synthesis = null;
        let currentUtterance = null;
        let recognitionActive = false;

        // Initialize speech recognition and synthesis
        function initializeSpeechServices() {
            console.log('üé§ Initializing speech services...');
            
            // Speech Recognition Setup
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-IN'; // Indian English for better VTU terms recognition

                recognition.onstart = function() {
                    console.log('üé§ Speech recognition started');
                    recognitionActive = true;
                    setVoiceListening(true);
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    console.log('üé§ Voice input:', transcript);
                    
                    if (transcript && transcript.trim()) {
                        // Enhanced voice processing for VTU terms
                        let processedTranscript = transcript;
                        
                        // Clean up common voice recognition errors for VTU registration
                        const voiceCorrections = {
                            'i want to change my name': 'name',
                            'change my name': 'name',
                            'update my name': 'name',
                            'modify my name': 'name',
                            
                            'i want to change my usn': 'usn',
                            'change my usn': 'usn',
                            'update my usn': 'usn',
                            'modify my usn': 'usn',
                            'u s n': 'usn',
                            'university seat number': 'usn',
                            
                            'i want to change my branch': 'branch',
                            'change my branch': 'branch',
                            'update my branch': 'branch',
                            'modify my branch': 'branch',
                            
                            'i want to change my semester': 'semester',
                            'change my semester': 'semester',
                            'update my semester': 'semester',
                            'modify my semester': 'semester',
                            'change semester': 'semester',
                            
                            'i want to change my email': 'email',
                            'change my email': 'email',
                            'update my email': 'email',
                            'modify my email': 'email',
                            'change email': 'email',
                            
                            'i want to change my subjects': 'subjects',
                            'change my subjects': 'subjects',
                            'update my subjects': 'subjects',
                            'modify my subjects': 'subjects',
                            'change subjects': 'subjects',

                            // VTU-specific terms
                            'computer science': 'CSE',
                            'information science': 'ISE', 
                            'electronics and communication': 'ECE',
                            'mechanical engineering': 'MECH',
                            'civil engineering': 'CIVIL',
                            'electrical and electronics': 'EEE',
                            'artificial intelligence': 'AIML',
                            'data science': 'DS'
                        };
                        
                        for (const [spoken, written] of Object.entries(voiceCorrections)) {
                            if (processedTranscript.includes(spoken)) {
                                processedTranscript = written;
                                break;
                            }
                        }
                        
                        document.getElementById('messageInput').value = processedTranscript;
                        setVoiceListening(false);
                        
                        // Auto-send after voice input
                        setTimeout(() => {
                            sendMessage();
                        }, 500);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('üé§ Speech recognition error:', event.error);
                    recognitionActive = false;
                    setVoiceListening(false);
                    showVoiceError(event.error);
                };

                recognition.onend = function() {
                    console.log('üé§ Speech recognition ended');
                    recognitionActive = false;
                    setVoiceListening(false);
                };
            } else {
                console.warn('üé§ Speech recognition not supported');
                disableVoiceFeatures();
            }

            // Speech Synthesis Setup
            if ('speechSynthesis' in window) {
                synthesis = window.speechSynthesis;
                console.log('üîä Speech synthesis initialized');
            } else {
                console.warn('üîä Speech synthesis not supported');
            }
        }

        // Initialize chat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing VTU Voice-Enabled Chatbot...');
            
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Initialize speech services
            initializeSpeechServices();

            // Show action buttons initially
            setTimeout(() => {
                document.getElementById('actionButtons').style.display = 'flex';
            }, 1000);

            // Add welcome voice message
            setTimeout(() => {
                speakText("Welcome to VTU Voice-Enabled Exam Registration! I can help you register using voice or text. How would you like to start?");
            }, 2000);
        });

        // Voice Recording Functions
        function toggleVoiceRecording() {
            if (!recognition) {
                showVoiceError('Speech recognition not supported in this browser');
                return;
            }

            if (isListening) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        function startVoiceRecording() {
            try {
                // Stop any current speech
                stopSpeaking();
                recognition.start();
                setVoiceStatus('listening', 'Listening...');
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                showVoiceError('Could not start voice recording');
            }
        }

        function stopVoiceRecording() {
            if (recognition) {
                recognition.stop();
            }
            setVoiceListening(false);
        }

        function setVoiceListening(listening) {
            isListening = listening;
            const voiceButton = document.getElementById('voiceButton');
            const voiceIcon = document.getElementById('voiceIcon');

            if (listening) {
                voiceButton.classList.add('listening');
                voiceIcon.className = 'fas fa-stop';
            } else {
                voiceButton.classList.remove('listening');
                voiceIcon.className = 'fas fa-microphone';
                hideVoiceStatus();
            }
        }

        function setVoiceStatus(type, text) {
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceStatusText = document.getElementById('voiceStatusText');

            voiceStatus.className = `voice-status ${type}`;
            voiceStatusText.textContent = text;
        }

        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.className = 'voice-status';
        }

        function showVoiceError(error) {
            let errorMsg = 'Voice error occurred';
            switch(error) {
                case 'network':
                    errorMsg = 'Network error. Please check your connection.';
                    break;
                case 'not-allowed':
                    errorMsg = 'Microphone access denied. Please enable microphone permissions.';
                    break;
                case 'no-speech':
                    errorMsg = 'No speech detected. Please try again.';
                    break;
                default:
                    errorMsg = `Voice error: ${error}`;
            }

            addMessage(`üé§ ${errorMsg}`, 'bot', 'error');
        }

        function disableVoiceFeatures() {
            const voiceButton = document.getElementById('voiceButton');
            voiceButton.style.display = 'none';

            const messageInput = document.getElementById('messageInput');
            messageInput.placeholder = 'Type your message here...';
        }

        // Text-to-Speech Functions
        function speakText(text) {
            if (!synthesis) return;

            // Stop any current speech
            synthesis.cancel();

            // Clean text for speech (remove markdown and special characters)
            const cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markers
                .replace(/\*(.*?)\*/g, '$1') // Remove italic markers
                .replace(/‚Ä¢/g, '') // Remove bullet points
                .replace(/‚ùå|‚úÖ|üìö|üéØ|üëã|üìù|üìÖ|üîÑ|‚ùì|üéì|üìä|üìã/g, '') // Remove emojis
                .replace(/\n/g, '. ') // Replace line breaks with pauses
                .trim();

            if (cleanText) {
                currentUtterance = new SpeechSynthesisUtterance(cleanText);
                currentUtterance.rate = 0.9;
                currentUtterance.pitch = 1;
                currentUtterance.volume = 0.8;
                currentUtterance.lang = 'en-IN';

                currentUtterance.onend = function() {
                    console.log('üîä Speech finished');
                };

                currentUtterance.onerror = function(event) {
                    console.error('üîä Speech error:', event.error);
                };

                synthesis.speak(currentUtterance);
            }
        }

        function stopSpeaking() {
            if (synthesis) {
                synthesis.cancel();
            }
        }

        // Enhanced send message function
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            // Check for empty message
            if (!message || isTyping) {
                if (!message) {
                    messageInput.focus();
                }
                return;
            }

            // Stop any current speech
            stopSpeaking();

            // Clear input and disable button
            messageInput.value = '';
            setInputState(false);

            // Add user message
            addMessage(message, 'user');

            // Show typing indicator
            showTyping(true);

            try {
                // Send to backend with voice flag
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        is_voice: recognitionActive // Pass voice flag
                    })
                });

                const data = await response.json();

                // Hide typing indicator
                showTyping(false);

                if (data.error) {
                    const errorMsg = `‚ùå Error: ${data.error}`;
                    addMessage(errorMsg, 'bot', 'error');
                    speakText(errorMsg);
                } else {
                    const messageClass = data.completed ? 'success' : 'bot';
                    addMessage(data.message, messageClass);

                    // Speak the bot response
                    setTimeout(() => {
                        speakText(data.voice_message || data.message);
                    }, 500);

                    if (data.completed) {
                        setTimeout(() => {
                            addCompletionButtons();
                        }, 2000);
                    }
                }
            } catch (error) {
                showTyping(false);
                const errorMsg = '‚ùå Connection error. Please try again.';
                addMessage(errorMsg, 'bot', 'error');
                speakText(errorMsg);
                console.error('Error:', error);
            }

            // Re-enable input
            setInputState(true);
            recognitionActive = false; // Reset voice flag
        }

        // Enhanced message adding function
        function addMessage(content, type, extraClass = '') {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');

            let messageClass = 'message ';
            if (type === 'user') {
                messageClass += 'user-message';
            } else if (type === 'success') {
                messageClass += 'bot-message success-message';
            } else if (extraClass === 'error') {
                messageClass += 'bot-message error-message';
            } else {
                messageClass += 'bot-message';
            }

            messageDiv.className = messageClass;

            // Format message content
            const formattedContent = formatMessageContent(content);

            // Add voice control for bot messages
            const voiceControl = type !== 'user' ? 
                `<div class="voice-controls">
                    <button class="voice-control-btn" onclick="speakText(\`${content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">
                        <i class="fas fa-volume-up"></i> Listen
                    </button>
                </div>` : '';

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${formattedContent}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
                ${voiceControl}
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            // Save to history
            chatHistory.push({ type, content, time: getCurrentTime() });
        }

        function formatMessageContent(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/‚Ä¢ /g, '&bull; ');
        }

        function showTyping(show) {
            const typingIndicator = document.getElementById('typingIndicator');
            const messagesContainer = document.getElementById('chatMessages');

            isTyping = show;
            typingIndicator.style.display = show ? 'flex' : 'none';

            if (show) {
                messagesContainer.appendChild(typingIndicator);
                scrollToBottom();
            }
        }

        function setInputState(enabled) {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const voiceButton = document.getElementById('voiceButton');

            messageInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            voiceButton.disabled = !enabled;

            if (enabled) {
                messageInput.focus();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
            document.getElementById('actionButtons').style.display = 'none';
        }

        function testVoice() {
            speakText("Voice test successful! I can speak your responses and understand your voice input. You can now register for VTU exams using voice commands.");
        }

        function addCompletionButtons() {
            const messagesContainer = document.getElementById('chatMessages');
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'message bot-message';
            buttonDiv.innerHTML = `
                <div class="message-content">
                    <strong>üéØ Registration Complete! What would you like to do next?</strong>
                    
                    <div class="voice-controls" style="margin-top: 10px;">
                        <button class="voice-control-btn" onclick="speakText('Registration complete! You can view dashboard, check subjects, access admin panel, or start new registration')">
                            <i class="fas fa-volume-up"></i> Listen
                        </button>
                    </div>
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            messagesContainer.appendChild(buttonDiv);
            scrollToBottom();
        }

        // Reset chat function
        async function resetChat() {
            if (confirm('Are you sure you want to start a new registration? This will clear the current conversation.')) {
                try {
                    stopSpeaking();
                    stopVoiceRecording();

                    await fetch('/api/reset', { method: 'POST' });

                    const messagesContainer = document.getElementById('chatMessages');
                    const welcomeMessage = messagesContainer.querySelector('.welcome-message');
                    messagesContainer.innerHTML = '';
                    messagesContainer.appendChild(welcomeMessage);

                    // Clear chat history
                    chatHistory.length = 0;
                    isTyping = false;
                    setInputState(true);

                    document.getElementById('actionButtons').style.display = 'flex';

                    const resetMsg = 'üîÑ Chat reset successfully! Ready for new VTU exam registration. Type "Hi" or click the microphone to start.';
                    addMessage(resetMsg, 'bot');

                    setTimeout(() => {
                        speakText('Chat reset successfully! How can I help you with your VTU exam registration?');
                    }, 1000);
                } catch (error) {
                    addMessage('‚ùå Error resetting chat. Please refresh the page.', 'bot', 'error');
                }
            }
        }

        // Auto-resize and responsive handling
        window.addEventListener('resize', function() {
            scrollToBottom();
        });

        // Prevent zoom on iOS
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        console.log('üéì VTU Voice-Enabled Chatbot loaded successfully!');
    </script>
</body>
</html>
